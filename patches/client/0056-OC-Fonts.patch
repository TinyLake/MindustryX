From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Sun, 28 Jul 2024 14:16:29 +0800
Subject: [PATCH] =?UTF-8?q?OC:=20=E6=95=B4=E7=90=86Fonts=E7=B1=BB?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

更好的字体包支持
---
 core/src/mindustry/ClientLauncher.java |  6 ++---
 core/src/mindustry/core/UI.java        |  4 ----
 core/src/mindustry/ui/Fonts.java       | 31 ++++++++++++++------------
 3 files changed, 19 insertions(+), 22 deletions(-)

diff --git a/core/src/mindustry/ClientLauncher.java b/core/src/mindustry/ClientLauncher.java
index a91ea8917a6c687d728e5d6fe1e39f2db53f2c87..06733410b5fb4a809c4d1043acee777443460979 100644
--- a/core/src/mindustry/ClientLauncher.java
+++ b/core/src/mindustry/ClientLauncher.java
@@ -149,10 +149,8 @@ public abstract class ClientLauncher extends ApplicationCore implements Platform
 
         assets.load(new Vars());
 
-        Fonts.loadDefaultFont();
-
         //load fallback atlas if max texture size is below 4096
-        assets.load(new AssetDescriptor<>(maxTextureSize >= 4096 ? "sprites/sprites.aatls" : "sprites/fallback/sprites.aatls", TextureAtlas.class)).loaded = t -> atlas = t;
+        assets.load(maxTextureSize >= 4096 ? "sprites/sprites.aatls" : "sprites/fallback/sprites.aatls", TextureAtlas.class).loaded = t -> atlas = t;
         assets.loadRun("maps", Map.class, () -> maps.loadPreviews());
 
         Musics.load();
@@ -167,11 +165,11 @@ public abstract class ClientLauncher extends ApplicationCore implements Platform
         });
 
         assets.load(mods);
-        assets.loadRun("mergeUI", PixmapPacker.class, () -> {}, () -> Fonts.mergeFontAtlas(atlas));
 
         add(logic = new Logic());
         add(control = new Control());
         add(renderer = new Renderer());
+        Fonts.loadFonts();
         add(ui = new UI());
         add(netServer = new NetServer());
         add(netClient = new NetClient());
diff --git a/core/src/mindustry/core/UI.java b/core/src/mindustry/core/UI.java
index 7bf9cf271e2bdb6afc0fdba422f588c17ec7f8cc..d9fdf6b7b03f288926ad343be9045aaa863e6e3a 100644
--- a/core/src/mindustry/core/UI.java
+++ b/core/src/mindustry/core/UI.java
@@ -82,10 +82,6 @@ public class UI implements ApplicationListener, Loadable{
 
     private @Nullable Element lastAnnouncement;
 
-    public UI(){
-        Fonts.loadFonts();
-    }
-
     public static void loadColors(){
         Colors.put("accent", Pal.accent);
         Colors.put("unlaunched", Color.valueOf("8982ed"));
diff --git a/core/src/mindustry/ui/Fonts.java b/core/src/mindustry/ui/Fonts.java
index b32847a353f8d9cda2424b17ecadd43be99afc5f..fe055ed5f0aa980f8177690bc14430bd6e920108 100644
--- a/core/src/mindustry/ui/Fonts.java
+++ b/core/src/mindustry/ui/Fonts.java
@@ -67,10 +67,25 @@ public class Fonts{
     }
 
     public static void loadFonts(){
+        loadDefaultFont();
         largeIcons.clear();
         FreeTypeFontParameter param = fontParameter();
 
         Core.assets.load("default", Font.class, new FreeTypeFontLoaderParameter(mainFont, param)).loaded = f -> Fonts.def = f;
+
+        Core.assets.load("outline", Font.class, new FreeTypeFontLoaderParameter(mainFont, new FreeTypeFontParameter(){{
+            borderColor = Color.darkGray;
+            incremental = true;
+            size = 18;
+        }})).loaded = t -> Fonts.outline = t;
+
+        Core.assets.load("tech", Font.class, new FreeTypeFontLoaderParameter("fonts/tech.ttf", new FreeTypeFontParameter(){{
+            size = 18;
+        }})).loaded = f -> {
+            Fonts.tech = f;
+            Fonts.tech.getData().down *= 1.5f;
+        };
+
         Core.assets.load("icon", Font.class, new FreeTypeFontLoaderParameter("fonts/icon.ttf", new FreeTypeFontParameter(){{
             size = 30;
             incremental = true;
@@ -83,6 +98,8 @@ public class Fonts{
             borderWidth = 5f;
             borderColor = Color.darkGray;
         }})).loaded = f -> Fonts.iconLarge = f;
+
+        Core.assets.loadRun("mergeUI", PixmapPacker.class, () -> {}, () -> Fonts.mergeFontAtlas(Core.atlas));
     }
 
     public static TextureRegion getLargeIcon(String name){
@@ -209,20 +226,6 @@ public class Fonts{
             }
         });
 
-        FreeTypeFontParameter param = new FreeTypeFontParameter(){{
-            borderColor = Color.darkGray;
-            incremental = true;
-            size = 18;
-        }};
-
-        Core.assets.load("outline", Font.class, new FreeTypeFontLoaderParameter(mainFont, param)).loaded = t -> Fonts.outline = t;
-
-        Core.assets.load("tech", Font.class, new FreeTypeFontLoaderParameter("fonts/tech.ttf", new FreeTypeFontParameter(){{
-            size = 18;
-        }})).loaded = f -> {
-            Fonts.tech = f;
-            Fonts.tech.getData().down *= 1.5f;
-        };
     }
 
     /** Merges the UI and font atlas together for better performance. */
