From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Thu, 3 Jul 2025 22:45:51 +0800
Subject: [PATCH] H MetricCollector.handleException

---
 core/src/mindustry/mod/Mods.java         | 14 ++++++++++----
 core/src/mindustry/net/CrashHandler.java | 16 ++++++++++++++++
 2 files changed, 26 insertions(+), 4 deletions(-)

diff --git a/core/src/mindustry/mod/Mods.java b/core/src/mindustry/mod/Mods.java
index fe2e89fd58994eb650158b9b7e6e254d9d70f570..6995ddd5cc49e67ee4f1eba26c2b00318cc6c1b7 100644
--- a/core/src/mindustry/mod/Mods.java
+++ b/core/src/mindustry/mod/Mods.java
@@ -23,6 +23,7 @@ import mindustry.graphics.MultiPacker.*;
 import mindustry.mod.ContentParser.*;
 import mindustry.type.*;
 import mindustry.ui.*;
+import mindustryX.features.MetricCollector.*;
 
 import java.io.*;
 import java.util.*;
@@ -306,10 +307,15 @@ public class Mods implements Loadable{
         for(Seq<Content> arr : content.getContentMap()){
             arr.each(c -> {
                 if(c instanceof UnlockableContent u && c.minfo.mod != null){
-                    u.load();
-                    u.loadIcon();
-                    if(u.generateIcons && !c.minfo.mod.meta.pregenerated){
-                        u.createIcons(packer);
+                    try{
+                        u.load();
+                        u.loadIcon();
+                        if(u.generateIcons && !c.minfo.mod.meta.pregenerated){
+                            u.createIcons(packer);
+                        }
+                    }catch(RuntimeException e){
+                        //MDTX: wrap and rethrow exception with mod details
+                        throw new ModRelatedException(c.minfo.mod, "Failed to generate icons for content " + c + ".", e);
                     }
                 }
             });
diff --git a/core/src/mindustry/net/CrashHandler.java b/core/src/mindustry/net/CrashHandler.java
index 16e0456c23a999db056f7645ce25dfa737653b34..ec89d0e1330573cb3e7dddad9881b018e9e62351 100644
--- a/core/src/mindustry/net/CrashHandler.java
+++ b/core/src/mindustry/net/CrashHandler.java
@@ -9,6 +9,7 @@ import arc.util.io.*;
 import mindustry.*;
 import mindustry.core.*;
 import mindustry.mod.Mods.*;
+import mindustryX.features.*;
 
 import java.io.*;
 import java.text.*;
@@ -20,6 +21,8 @@ import static mindustry.Vars.*;
 public class CrashHandler{
 
     public static String createReport(Throwable exception){
+        MetricCollector.INSTANCE.handleException(exception);
+
         String error = writeException(exception);
         LoadedMod cause = getModCause(exception);
 
@@ -49,6 +52,7 @@ public class CrashHandler{
         try{
             Core.settings.getDataDirectory().child("crashes").child("crash_" + System.currentTimeMillis() + ".txt")
             .writeString(createReport(exception));
+            MetricCollector.INSTANCE.waitPost();//MDTX:Wait before exiting.
         }catch(Throwable ignored){
         }
     }
@@ -113,6 +117,7 @@ public class CrashHandler{
             death.printStackTrace();
         }
 
+        MetricCollector.INSTANCE.waitPost();//MDTX:Wait before exiting.
         System.exit(1);
     }
 
@@ -122,6 +127,17 @@ public class CrashHandler{
         try{
             for(var element : e.getStackTrace()){
                 String name = element.getClassName();
+                //MDTX: match based on classloader
+                try{
+                    ClassLoader classLoader = mods.mainLoader().loadClass(name).getClassLoader();
+                    if(classLoader == CrashHandler.class.getClassLoader()) continue;
+                    for(var mod : mods.list()){
+                        if(mod.loader != null && mod.loader == classLoader){
+                            return mod;
+                        }
+                    }
+                }catch(ClassNotFoundException|NullPointerException ignored){
+                }
                 if(!name.matches("(mindustry|arc|java|javax|sun|jdk)\\..*")){
                     for(var mod : mods.list()){
                         if(mod.meta.main != null && getMatches(mod.meta.main, name) > 0){
