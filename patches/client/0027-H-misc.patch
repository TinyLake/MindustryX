From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Sun, 18 Feb 2024 15:58:00 +0800
Subject: [PATCH] H: misc
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

每个改动仅限连续的一段，且前有注释说明改动内容
---
 core/src/mindustry/ClientLauncher.java        |  8 ++++++++
 core/src/mindustry/Vars.java                  |  5 +++++
 core/src/mindustry/ai/BlockIndexer.java       |  2 +-
 core/src/mindustry/content/Blocks.java        |  2 ++
 core/src/mindustry/content/StatusEffects.java |  1 +
 core/src/mindustry/core/Control.java          |  3 ++-
 core/src/mindustry/core/NetClient.java        |  4 ++++
 core/src/mindustry/core/Renderer.java         |  2 +-
 core/src/mindustry/core/UI.java               | 20 ++-----------------
 core/src/mindustry/game/Schematics.java       |  8 +++++---
 .../mindustry/graphics/MinimapRenderer.java   |  6 ++++--
 core/src/mindustry/input/DesktopInput.java    |  3 +++
 .../mindustry/ui/dialogs/DatabaseDialog.java  |  4 ++++
 core/src/mindustry/ui/dialogs/JoinDialog.java | 19 ++++++++++--------
 .../mindustry/ui/dialogs/KeybindDialog.java   | 12 +++++++----
 .../mindustry/ui/dialogs/PausedDialog.java    |  3 ++-
 .../ui/dialogs/SettingsMenuDialog.java        |  4 ++--
 .../mindustry/ui/fragments/ChatFragment.java  |  7 +++++--
 .../ui/fragments/PlacementFragment.java       |  6 ++----
 .../mindustry/world/blocks/defense/Radar.java |  9 +++++++++
 .../world/blocks/distribution/Router.java     |  3 ++-
 .../world/blocks/units/Reconstructor.java     | 12 ++++-------
 22 files changed, 87 insertions(+), 56 deletions(-)

diff --git a/core/src/mindustry/ClientLauncher.java b/core/src/mindustry/ClientLauncher.java
index 4145f77e4680b962aa3ed89e414095ad71ecdb46..03945cddb87fc0c8fb583f126dde24fa60427e0c 100644
--- a/core/src/mindustry/ClientLauncher.java
+++ b/core/src/mindustry/ClientLauncher.java
@@ -37,6 +37,10 @@ public abstract class ClientLauncher extends ApplicationCore implements Platform
     @Override
     public void setup(){
         String dataDir = System.getProperty("mindustry.data.dir", OS.env("MINDUSTRY_DATA_DIR"));
+        //MDTX Auto discover `data` directory to use portal mode.
+        if(app.isDesktop() && dataDir == null && Fi.get("data").isDirectory()){
+            dataDir = "data";
+        }
         if(dataDir != null){
             Core.settings.setDataDirectory(files.absolute(dataDir));
         }
@@ -264,10 +268,14 @@ public abstract class ClientLauncher extends ApplicationCore implements Platform
         }
 
         if(limitFps){
+            Gl.flush();//MDTX: flush GL, let the GPU do the work before swap buffer.
             long current = Time.nanos();
             if(nextFrame > current){
                 long toSleep = nextFrame - current;
                 Threads.sleep(toSleep / 1000000, (int)(toSleep % 1000000));
+            }else{
+                //MDTX fix limitFps sometime not working.
+                nextFrame = current;
             }
         }
 
diff --git a/core/src/mindustry/Vars.java b/core/src/mindustry/Vars.java
index 25c9cdeb5a6a49d616cafacb21d04172d0fbf59f..37866577b7274f0d0f2f00f0dcc5b74e7c38139b 100644
--- a/core/src/mindustry/Vars.java
+++ b/core/src/mindustry/Vars.java
@@ -420,6 +420,11 @@ public class Vars implements Loadable{
                 if(!headless && (ui == null || ui.consolefrag == null)){
                     logBuffer.add(result);
                 }else if(!headless){
+                    //MDTX add message to console
+                    if(!logBuffer.isEmpty()){
+                        logBuffer.each(ui.consolefrag::addMessage);
+                        logBuffer.clear();
+                    }
                     if(!OS.isWindows){
                         for(String code : ColorCodes.values){
                             result = result.replace(code, "");
diff --git a/core/src/mindustry/ai/BlockIndexer.java b/core/src/mindustry/ai/BlockIndexer.java
index 11278ddac6ce2b35234acb31b43ea7e8c999592d..ed6785c5853a9a8096b2f48792c05b98292947cd 100644
--- a/core/src/mindustry/ai/BlockIndexer.java
+++ b/core/src/mindustry/ai/BlockIndexer.java
@@ -38,7 +38,7 @@ public class BlockIndexer{
     /** All ores present on the map - can be wall or floor. */
     private Seq<Item> allPresentOres = new Seq<>();
     /** All ores available on this map. */
-    private ObjectIntMap<Item> allOres = new ObjectIntMap<>(), allWallOres = new ObjectIntMap<>();
+    public ObjectIntMap<Item> allOres = new ObjectIntMap<>(), allWallOres = new ObjectIntMap<>();
     /** Stores teams that are present here as tiles. */
     private Seq<Team> activeTeams = new Seq<>(Team.class);
     /** Maps teams to a map of flagged tiles by flag. */
diff --git a/core/src/mindustry/content/Blocks.java b/core/src/mindustry/content/Blocks.java
index 566c2132c044f1257a19bf9eb7ed6966ee4c9d0b..deee4bf82f0b3df84f86d41745eab9646bef8e7d 100644
--- a/core/src/mindustry/content/Blocks.java
+++ b/core/src/mindustry/content/Blocks.java
@@ -2113,6 +2113,7 @@ public class Blocks{
             speed = 74f;
             arrowSpacing = 6f;
             bufferCapacity = 14;
+            allowConfigInventory = true; //MDTX: config inventory for bridge
         }};
 
         phaseConveyor = new ItemBridge("phase-conveyor"){{
@@ -2125,6 +2126,7 @@ public class Blocks{
             pulse = true;
             envEnabled |= Env.space;
             consumePower(0.30f);
+            allowConfigInventory = true; //MDTX: config inventory for bridge
         }};
 
         sorter = new Sorter("sorter"){{
diff --git a/core/src/mindustry/content/StatusEffects.java b/core/src/mindustry/content/StatusEffects.java
index 7e9466f2d629335317b2a706b376d33aab029923..51669a3c774069bdb5f3189a52fd938657aeb30e 100644
--- a/core/src/mindustry/content/StatusEffects.java
+++ b/core/src/mindustry/content/StatusEffects.java
@@ -206,6 +206,7 @@ public class StatusEffects{
 
         invincible = new StatusEffect("invincible"){{
             healthMultiplier = Float.POSITIVE_INFINITY;
+            color = Color.red;
         }};
 
         dynamic = new StatusEffect("dynamic"){{
diff --git a/core/src/mindustry/core/Control.java b/core/src/mindustry/core/Control.java
index b47359f11124b09334d3f3d108a18da2dfd57daf..3985cd03a36d24c55f465822eed6d12074e56094 100644
--- a/core/src/mindustry/core/Control.java
+++ b/core/src/mindustry/core/Control.java
@@ -603,7 +603,8 @@ public class Control implements ApplicationListener, Loadable{
                 BaseDialog dialog = new BaseDialog("@confirm");
                 dialog.setFillParent(true);
 
-                float[] countdown = {60 * 11};
+                //MDTX ARC: longer timeout
+                float[] countdown = {60 * 31};
                 Runnable exit = () -> {
                     Core.settings.put("uiscale", 100);
                     Core.settings.put("uiscalechanged", false);
diff --git a/core/src/mindustry/core/NetClient.java b/core/src/mindustry/core/NetClient.java
index 77e23fff3efb2bc6d4ed8ca01086716823d3c869..61ef7a6ae1a82d078d4eb1d91a06215d5b191a57 100644
--- a/core/src/mindustry/core/NetClient.java
+++ b/core/src/mindustry/core/NetClient.java
@@ -72,6 +72,10 @@ public class NetClient implements ApplicationListener{
     public NetClient(){
 
         net.handleClient(Connect.class, packet -> {
+            //MDTX ARC: fix name when quietReset
+            player.name = Core.settings.getString("name");
+            player.color.set(Core.settings.getInt("color-0"));
+
             Log.info("Connecting to server: @", packet.addressTCP);
 
             player.admin = false;
diff --git a/core/src/mindustry/core/Renderer.java b/core/src/mindustry/core/Renderer.java
index 0c6d636cd64c9d1dd782d3eb46d840414b56e27f..e5453c4567d808e40ea5039b57d8ed83f854f2f7 100644
--- a/core/src/mindustry/core/Renderer.java
+++ b/core/src/mindustry/core/Renderer.java
@@ -160,7 +160,7 @@ public class Renderer implements ApplicationListener{
             baseTarget = Mathf.lerp(minZoom, maxZoom, control.input.logicCutsceneZoom);
         }
 
-        float dest = Mathf.clamp(Mathf.round(baseTarget, 0.5f), minScale(), maxScale());
+        float dest = Mathf.clamp(Mathf.round(baseTarget, 0.1f), minScale(), maxScale());
         camerascale = Mathf.lerpDelta(camerascale, dest, 0.1f);
         if(Mathf.equal(camerascale, dest, 0.001f)) camerascale = dest;
         unitLaserOpacity = settings.getInt("unitlaseropacity") / 100f;
diff --git a/core/src/mindustry/core/UI.java b/core/src/mindustry/core/UI.java
index daaa194524f5d1afad10f2c3b0731e8ae68da124..a62f8737b3037c8c25c34a84e22369cb0e434473 100644
--- a/core/src/mindustry/core/UI.java
+++ b/core/src/mindustry/core/UI.java
@@ -607,7 +607,7 @@ public class UI implements ApplicationListener, Loadable{
                 t.remove();
             }
         });
-        t.actions(Actions.fadeOut(duration, Interp.pow4In), Actions.remove());
+        t.actions(Actions.fadeOut(Math.min(duration,30f), Interp.pow4In), Actions.remove());
         t.pack();
         t.act(0.1f);
         Core.scene.add(t);
@@ -746,23 +746,7 @@ public class UI implements ApplicationListener, Loadable{
     }
 
     public static String formatAmount(long number){
-        //prevent things like bars displaying erroneous representations of casted infinities
-        if(number == Long.MAX_VALUE) return "∞";
-        if(number == Long.MIN_VALUE) return "-∞";
-
-        long mag = Math.abs(number);
-        String sign = number < 0 ? "-" : "";
-        if(mag >= 1_000_000_000){
-            return sign + Strings.fixed(mag / 1_000_000_000f, 1) + "[gray]" + billions + "[]";
-        }else if(mag >= 1_000_000){
-            return sign + Strings.fixed(mag / 1_000_000f, 1) + "[gray]" + millions + "[]";
-        }else if(mag >= 10_000){
-            return number / 1000 + "[gray]" + thousands + "[]";
-        }else if(mag >= 1000){
-            return sign + Strings.fixed(mag / 1000f, 1) + "[gray]" + thousands + "[]";
-        }else{
-            return number + "";
-        }
+        return mindustryX.features.ui.FormatDefault.format(number);
     }
 
     public static int roundAmount(int number){
diff --git a/core/src/mindustry/game/Schematics.java b/core/src/mindustry/game/Schematics.java
index 2333f83d451cd664633dc38c9f7d2b0911962398..0ca9f1a37d3f46842a5d1212b0f633dd9de2ae48 100644
--- a/core/src/mindustry/game/Schematics.java
+++ b/core/src/mindustry/game/Schematics.java
@@ -99,7 +99,9 @@ public class Schematics implements Loadable{
         all.sort();
 
         if(shadowBuffer == null && !headless){
-            Core.app.post(() -> shadowBuffer = new FrameBuffer(maxSchematicSize + padding + 8, maxSchematicSize + padding + 8));
+            //MDTX: support larger schematic, maxSchematicSize may be MAX_VALUE
+            var size = Math.min(maxSchematicSize, 1024) + padding + 8;
+            Core.app.post(() -> shadowBuffer = new FrameBuffer(size, size));
         }
     }
 
@@ -550,7 +552,7 @@ public class Schematics implements Loadable{
         try(DataInputStream stream = new DataInputStream(new InflaterInputStream(input))){
             short width = stream.readShort(), height = stream.readShort();
 
-            if(width > 128 || height > 128) throw new IOException("Invalid schematic: Too large (max possible size is 128x128)");
+            if(width > 1024 || height > 1024) throw new IOException("Invalid schematic: Too large (max possible size is 128x128)");
 
             StringMap map = new StringMap();
             int tags = stream.readUnsignedByte();
@@ -591,7 +593,7 @@ public class Schematics implements Loadable{
 
             int total = stream.readInt();
 
-            if(total > 128 * 128) throw new IOException("Invalid schematic: Too many blocks.");
+            if(maxSchematicSize != Integer.MAX_VALUE && total > Math.max(maxSchematicSize * maxSchematicSize, 128 * 128)) throw new IOException("Invalid schematic: Too many blocks.");
 
             Reads read = new Reads(stream);
 
diff --git a/core/src/mindustry/graphics/MinimapRenderer.java b/core/src/mindustry/graphics/MinimapRenderer.java
index 80892c624209e6f7e788c5c96b80f1f83a10d809..9101c36aaa4919cd52e1cd3bfb1bfab281076f3d 100644
--- a/core/src/mindustry/graphics/MinimapRenderer.java
+++ b/core/src/mindustry/graphics/MinimapRenderer.java
@@ -102,7 +102,8 @@ public class MinimapRenderer{
     }
 
     public void setZoom(float amount){
-        zoom = Mathf.clamp(amount, 1f, Math.min(world.width(), world.height()) / baseSize / 2f);
+        //MDTX ARC: max instead min to view full map.
+        zoom = Mathf.clamp(amount, 1f, Math.max(world.width(), world.height()) / baseSize / 2f);
     }
 
     public float getZoom(){
@@ -296,7 +297,8 @@ public class MinimapRenderer{
     public @Nullable TextureRegion getRegion(){
         if(texture == null) return null;
 
-        float sz = Mathf.clamp(baseSize * zoom, baseSize, Math.min(world.width(), world.height()));
+        //MDTX: use max to render full minimap.
+        float sz = Mathf.clamp(baseSize * zoom, baseSize, Math.max(world.width(), world.height()));
         float dx = (Core.camera.position.x / tilesize);
         float dy = (Core.camera.position.y / tilesize);
         dx = Mathf.clamp(dx, sz, world.width() - sz);
diff --git a/core/src/mindustry/input/DesktopInput.java b/core/src/mindustry/input/DesktopInput.java
index 1b398a99d5c870f091da5cbe6f0a7dd44803301d..f7ac4952272dbf657cbf2b4bc74a320ebd967dc9 100644
--- a/core/src/mindustry/input/DesktopInput.java
+++ b/core/src/mindustry/input/DesktopInput.java
@@ -409,6 +409,9 @@ public class DesktopInput extends InputHandler{
                         }
                         lastCtrlGroup = i;
                         lastCtrlGroupSelectMillis = Time.millis();
+
+                        //MDTX: anuke forgot it
+                        Events.fire(Trigger.unitCommandChange);
                     }
                 }
             }
diff --git a/core/src/mindustry/ui/dialogs/DatabaseDialog.java b/core/src/mindustry/ui/dialogs/DatabaseDialog.java
index 663110a852d5b63e5da40ee62dac10a3a329852b..d7336fd7431ce571e5a7b999ebc40d315a109c82 100644
--- a/core/src/mindustry/ui/dialogs/DatabaseDialog.java
+++ b/core/src/mindustry/ui/dialogs/DatabaseDialog.java
@@ -96,6 +96,7 @@ public class DatabaseDialog extends BaseDialog{
             }
         }).row();
 
+        ObjectSet<Object> usedpatches = Reflect.get(state.patcher, "usedpatches");
         for(int j = 0; j < allContent.length; j++){
             ContentType type = ContentType.all[j];
 
@@ -129,6 +130,9 @@ public class DatabaseDialog extends BaseDialog{
                             setColor(Color.scarlet);
                             touchable = Touchable.disabled;
                         }}).size(8 * 4).pad(3);
+                    }else if(state.isGame() && usedpatches.contains(unlock)){
+                        //MDTX: border for patched content
+                        list.table(Tex.whiteui, t -> t.add(image).size(8 * 4).pad(2)).color(Pal.accent).pad(1);
                     }else{
                         list.add(image).size(8 * 4).pad(3);
                     }
diff --git a/core/src/mindustry/ui/dialogs/JoinDialog.java b/core/src/mindustry/ui/dialogs/JoinDialog.java
index 3598459b4c4c22fc23a79c44b4f47f6c305f9bbf..ffcb29c15f2e1ab996a36cda95b845d64028a9b3 100644
--- a/core/src/mindustry/ui/dialogs/JoinDialog.java
+++ b/core/src/mindustry/ui/dialogs/JoinDialog.java
@@ -61,11 +61,9 @@ public class JoinDialog extends BaseDialog{
 
         loadServers();
 
-        //mobile players don't get information >:(
-        boolean infoButton = !steam && !mobile;
-
-        if(infoButton) buttons.add().width(60f);
-        buttons.add().growX().width(-1);
+        //MDTX: keep for compatibility to CLaj Mod
+        buttons.add().width(Float.MIN_NORMAL).pad(0);
+        buttons.add().width(Float.MIN_NORMAL).pad(0);
 
         addCloseButton(mobile ? 190f : 210f);
 
@@ -73,9 +71,14 @@ public class JoinDialog extends BaseDialog{
             renaming = null;
             add.show();
         });
-
-        buttons.add().growX().width(-1);
-        if(infoButton) buttons.button("?", () -> ui.showInfo("@join.info")).size(60f, 64f);
+        //MDTX: keep for compatibility to CLaj Mod
+        buttons.add().width(Float.MIN_NORMAL).pad(0);
+        buttons.add().width(Float.MIN_NORMAL).pad(0);
+        //MDTX: better fixed info button
+        buttons.addChild(new Table(t -> {
+            t.setFillParent(true);
+            t.right().bottom().button("?", () -> ui.showInfo("@join.info")).size(60f, 64f);
+        }));
 
         add = new BaseDialog("@joingame.title");
         add.cont.add("@joingame.ip").padRight(5f).left();
diff --git a/core/src/mindustry/ui/dialogs/KeybindDialog.java b/core/src/mindustry/ui/dialogs/KeybindDialog.java
index e56d2f43cc0dbea91986edefd29189327d409bb6..e26fecde81717004b5561c53dc43ae28579d24f3 100644
--- a/core/src/mindustry/ui/dialogs/KeybindDialog.java
+++ b/core/src/mindustry/ui/dialogs/KeybindDialog.java
@@ -79,7 +79,7 @@ public class KeybindDialog extends Dialog{
         String lastCategory = null;
         var tstyle = Styles.grayt;
 
-        float bw = 140f, bh = 40f;
+        float bw = 100f, bh = 40f;
 
         for(KeyBind keybind : KeyBind.all){
             if(!searchText.isEmpty() && !bundle.get("keybind." + keybind.name + ".name", keybind.name).toLowerCase(Locale.ROOT).contains(searchText.toLowerCase(Locale.ROOT))){
@@ -87,8 +87,8 @@ public class KeybindDialog extends Dialog{
             }
 
             if(lastCategory != keybind.category && keybind.category != null){
-                table.add(bundle.get("category." + keybind.category + ".name", Strings.capitalize(keybind.category))).color(Color.gray).colspan(4).pad(10).padBottom(4).row();
-                table.image().color(Color.gray).fillX().height(3).pad(6).colspan(4).padTop(0).padBottom(10).row();
+                table.add(bundle.get("category." + keybind.category + ".name", Strings.capitalize(keybind.category))).color(Color.gray).colspan(5).pad(10).padBottom(4).row();//MDTX: fix colspan for unbind
+                table.image().color(Color.gray).fillX().height(3).pad(6).colspan(5).padTop(0).padBottom(10).row();//MDTX: fix colspan for unbind
                 lastCategory = keybind.category;
             }
 
@@ -115,11 +115,15 @@ public class KeybindDialog extends Dialog{
                     openDialog(keybind);
                 }).size(bw, bh);
             }
+            table.button("取消绑定", tstyle, () -> {
+                keybind.value = new Axis(KeyCode.unset);
+                keybind.save();
+            }).size(bw, bh).pad(2f).padLeft(4f);
             table.button("@settings.resetKey", tstyle, keybind::resetToDefault).disabled(t -> keybind.isDefault()).size(bw, bh).pad(2f).padLeft(4f);
             table.row();
         }
 
-        table.button("@settings.reset", Icon.refresh, tstyle, KeyBind::resetAll).minWidth(200f).colspan(4).padTop(4).margin(10f).height(50f).fill();
+        table.button("@settings.reset", Icon.refresh, tstyle, KeyBind::resetAll).minWidth(200f).colspan(5).padTop(4).margin(10f).height(50f).fill();//MDTX: fix colspan for unbind
     }
 
     void rebind(KeyBind bind, KeyCode newKey){
diff --git a/core/src/mindustry/ui/dialogs/PausedDialog.java b/core/src/mindustry/ui/dialogs/PausedDialog.java
index 8c8b7c49668a1adb90aa0d018c18f66ed6deeb6e..3e0cca2191e2fd062b96af031a6b2af5ba80e224 100644
--- a/core/src/mindustry/ui/dialogs/PausedDialog.java
+++ b/core/src/mindustry/ui/dialogs/PausedDialog.java
@@ -163,7 +163,8 @@ public class PausedDialog extends BaseDialog{
         boolean wasClient = net.client();
         if(net.client()) netClient.disconnectQuietly();
 
-        if(state.isEditor() && !wasClient){
+        //MDTX: isEditor may set by AdvancedTools, causing Crash.
+        if(state.isEditor() && !wasClient && state.map.name().equals("Editor Playtesting")){
             ui.editor.resumeEditing();
             return;
         }else if(checkPlaytest()){
diff --git a/core/src/mindustry/ui/dialogs/SettingsMenuDialog.java b/core/src/mindustry/ui/dialogs/SettingsMenuDialog.java
index 7949471868168ce97170f6550ce2949c7590506b..6e0bd9f94bd41137ddc69bae8beb7727d12ac6c0 100644
--- a/core/src/mindustry/ui/dialogs/SettingsMenuDialog.java
+++ b/core/src/mindustry/ui/dialogs/SettingsMenuDialog.java
@@ -408,14 +408,14 @@ public class SettingsMenuDialog extends BaseDialog{
         graphics.sliderPref("unitlaseropacity", 100, 0, 100, 5, s -> s + "%");
         graphics.sliderPref("bridgeopacity", 100, 0, 100, 5, s -> s + "%");
 
-        graphics.sliderPref("maxmagnificationmultiplierpercent", 100, 100, 200, 25, s -> {
+        graphics.sliderPref("maxmagnificationmultiplierpercent", 100, 100, 300, 25, s -> { //MDTX max 200->300
             if(ui.settings != null){
                 Core.settings.put("maxzoomingamemultiplier", (float)s / 100.0f);
             }
             return s + "%";
         });
 
-        graphics.sliderPref("minmagnificationmultiplierpercent", 100, 100, 300, 25, s -> {
+        graphics.sliderPref("minmagnificationmultiplierpercent", 100, 100, 800, 25, s -> { //MDTX max 300->800
             if(ui.settings != null){
                 Core.settings.put("minzoomingamemultiplier", (float)s / 100.0f);
             }
diff --git a/core/src/mindustry/ui/fragments/ChatFragment.java b/core/src/mindustry/ui/fragments/ChatFragment.java
index add50b5864c311b66d4278e684a4e0260170139f..6202aadb499174630a04c0210e7390a0af4f6a42 100644
--- a/core/src/mindustry/ui/fragments/ChatFragment.java
+++ b/core/src/mindustry/ui/fragments/ChatFragment.java
@@ -5,6 +5,7 @@ import arc.Input.*;
 import arc.func.*;
 import arc.graphics.*;
 import arc.graphics.g2d.*;
+import arc.input.*;
 import arc.math.*;
 import arc.scene.*;
 import arc.scene.ui.*;
@@ -30,7 +31,7 @@ public class ChatFragment extends Table{
     private boolean shown = false;
     private TextField chatfield;
     private Label fieldlabel = new Label(">");
-    private ChatMode mode = ChatMode.normal;
+    public ChatMode mode = ChatMode.normal;
     private Font font;
     private GlyphLayout layout = new GlyphLayout();
     private float offsetx = Scl.scl(4), offsety = Scl.scl(4), fontoffsetx = Scl.scl(2), chatspace = Scl.scl(50);
@@ -74,6 +75,8 @@ public class ChatFragment extends Table{
                     historyPos--;
                     updateChat();
                 }
+                //MDTX: disable FocusTraversal when tab is used as chat_mode
+                chatfield.setFocusTraversal(Binding.chatMode.value.key != KeyCode.tab);
                 if(input.keyTap(Binding.chatMode)){
                     nextMode();
                 }
@@ -292,7 +295,7 @@ public class ChatFragment extends Table{
         if(scrollPos > 0) scrollPos++;
     }
 
-    private enum ChatMode{
+    public enum ChatMode{
         normal(""),
         team("/t"),
         admin("/a", player::admin)
diff --git a/core/src/mindustry/ui/fragments/PlacementFragment.java b/core/src/mindustry/ui/fragments/PlacementFragment.java
index 7df456cb0c2465507c2faa8fe6f4ca8eee7b0425..60cedfaecdb8a85dcfccc30ca090aa48e3463350 100644
--- a/core/src/mindustry/ui/fragments/PlacementFragment.java
+++ b/core/src/mindustry/ui/fragments/PlacementFragment.java
@@ -756,10 +756,8 @@ public class PlacementFragment{
 
     /** @return the thing being hovered over. */
     public @Nullable Displayable hovered(){
-        Vec2 v = topTable.stageToLocalCoordinates(Core.input.mouse());
-
-        //if the mouse intersects the table or the UI has the mouse, no hovering can occur
-        if(Core.scene.hasMouse(Core.input.mouseX(), Core.input.mouseY()) || topTable.hit(v.x, v.y, false) != null) return null;
+        //MDTX: fix flashing. Don't clear hover if the mouse just on topTable.
+        if(Core.scene.hasMouse(Core.input.mouseX(), Core.input.mouseY()) && !topTable.hasMouse()) return null;
 
         //check for a unit
         Unit unit = Units.closestOverlap(player.team(), Core.input.mouseWorldX(), Core.input.mouseWorldY(), 5f, u -> !u.isLocal() && u.displayable());
diff --git a/core/src/mindustry/world/blocks/defense/Radar.java b/core/src/mindustry/world/blocks/defense/Radar.java
index e24a3368d190f64fdaf002130a76f4799834c9a5..0811c4520865cff648084cbc743a141367a103c5 100644
--- a/core/src/mindustry/world/blocks/defense/Radar.java
+++ b/core/src/mindustry/world/blocks/defense/Radar.java
@@ -3,12 +3,14 @@ package mindustry.world.blocks.defense;
 import arc.graphics.*;
 import arc.graphics.g2d.*;
 import arc.math.*;
+import arc.math.geom.*;
 import arc.struct.*;
 import arc.util.io.*;
 import mindustry.*;
 import mindustry.annotations.Annotations.*;
 import mindustry.gen.*;
 import mindustry.graphics.*;
+import mindustry.input.*;
 import mindustry.world.*;
 import mindustry.world.meta.*;
 
@@ -45,6 +47,13 @@ public class Radar extends Block{
         Drawf.dashCircle(x * tilesize + offset, y * tilesize + offset, fogRadius * tilesize, Pal.accent);
     }
 
+    //MDTX: 自动控制放置距离
+    @Override
+    public void changePlacementPath(Seq<Point2> points, int rotation){
+        var placeRadius2 = Mathf.pow(fogRadius, 2f) * 3;//*2/sqrt(3)/2
+        Placement.calculateNodes(points, this, rotation, (point, other) -> point.dst2(other) <= placeRadius2);
+    }
+
     public class RadarBuild extends Building{
         public float progress;
         public float lastRadius = 0f;
diff --git a/core/src/mindustry/world/blocks/distribution/Router.java b/core/src/mindustry/world/blocks/distribution/Router.java
index cbe6d64d52f66d38be69a897a9a1a2f5b928e631..c5fe7f0080fea29764ebd94f576f1f98549e06a3 100644
--- a/core/src/mindustry/world/blocks/distribution/Router.java
+++ b/core/src/mindustry/world/blocks/distribution/Router.java
@@ -41,7 +41,8 @@ public class Router extends Block{
 
         @Override
         public boolean canControl(){
-            return size == 1;
+            //MDTX ARC: router YES, larger router YES
+            return size != 0;
         }
 
         @Override
diff --git a/core/src/mindustry/world/blocks/units/Reconstructor.java b/core/src/mindustry/world/blocks/units/Reconstructor.java
index ef917ff030d1ca22e952530ca0df86133fcc48f5..db59ca748daedb56acc5f0968ec8f7bf9f1f6c32 100644
--- a/core/src/mindustry/world/blocks/units/Reconstructor.java
+++ b/core/src/mindustry/world/blocks/units/Reconstructor.java
@@ -178,7 +178,7 @@ public class Reconstructor extends UnitBlock{
 
         public boolean canSetCommand(){
             var output = unit();
-            return output != null && output.commands.size > 1 && output.allowChangeCommands;
+            return output == null || (output.commands.size > 1 && output.allowChangeCommands);
         }
 
         @Override
@@ -195,25 +195,21 @@ public class Reconstructor extends UnitBlock{
         public void buildConfiguration(Table table){
             var unit = unit();
 
-            if(unit == null){
-                deselect();
-                return;
-            }
-
             var group = new ButtonGroup<ImageButton>();
             group.setMinCheckCount(0);
             int i = 0, columns = 4;
 
             table.background(Styles.black6);
 
-            var list = unit().commands;
+            //MDTX: allow client to preset the command.
+            var list = unit == null ? Vars.content.unitCommands() : unit.commands;
             for(var item : list){
                 ImageButton button = table.button(item.getIcon(), Styles.clearNoneTogglei, 40f, () -> {
                     configure(item);
                     deselect();
                 }).tooltip(item.localized()).group(group).get();
 
-                button.update(() -> button.setChecked(command == item || (command == null && unit.defaultCommand == item)));
+                button.update(() -> button.setChecked(command == item || (command == null && unit != null && unit.defaultCommand == item)));
 
                 if(++i % columns == 0){
                     table.row();
