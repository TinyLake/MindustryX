From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Wed, 20 Mar 2024 23:51:15 +0800
Subject: [PATCH] HC: ReplayController
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

兼容ARC的mrep格式
way-zer <himc.wicp@gmail.com> on 2024/4/22 at 18:10

实现功能按钮
way-zer <himc.wicp@gmail.com> on 2024/4/22 at 20:15
---
 core/src/mindustry/core/NetClient.java | 2 ++
 core/src/mindustry/io/TypeIO.java      | 2 +-
 core/src/mindustry/net/Net.java        | 2 ++
 3 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/core/src/mindustry/core/NetClient.java b/core/src/mindustry/core/NetClient.java
index f1923596677f5027bc4a3179da92082bbd71cf15..30c37c2c8f912865d800690664290cbdb314cfd6 100644
--- a/core/src/mindustry/core/NetClient.java
+++ b/core/src/mindustry/core/NetClient.java
@@ -28,6 +28,7 @@ import mindustry.net.Packets.*;
 import mindustry.world.*;
 import mindustry.world.modules.*;
 import mindustryX.*;
+import mindustryX.features.*;
 
 import java.io.*;
 import java.util.*;
@@ -115,6 +116,7 @@ public class NetClient implements ApplicationListener{
                 return;
             }
 
+            ReplayController.onConnect(packet.addressTCP);
             net.send(c, true);
         });
 
diff --git a/core/src/mindustry/io/TypeIO.java b/core/src/mindustry/io/TypeIO.java
index f174d06288d5adcffa6f8f60cbefe18d8fd40fe1..930b7462db02bd201fae6e694b9cc258b24be16b 100644
--- a/core/src/mindustry/io/TypeIO.java
+++ b/core/src/mindustry/io/TypeIO.java
@@ -318,7 +318,7 @@ public class TypeIO{
             netClient.addRemovedEntity(entity.id());
         }
 
-        return null; //no need to actually return anything
+        return new UnitSyncContainer(entity); //MDTX: We should return non-null
     }
 
     public static void writeUnit(Writes write, Unit unit){
diff --git a/core/src/mindustry/net/Net.java b/core/src/mindustry/net/Net.java
index 5cfafc4fba4b6a056f77256a674812b53498139f..81b815965da3409ebee50b5aab5eaf59a7dadbfd 100644
--- a/core/src/mindustry/net/Net.java
+++ b/core/src/mindustry/net/Net.java
@@ -11,6 +11,7 @@ import mindustry.gen.*;
 import mindustry.net.Packets.*;
 import mindustry.net.Streamable.*;
 import mindustryX.events.*;
+import mindustryX.features.*;
 import net.jpountz.lz4.*;
 
 import java.io.*;
@@ -294,6 +295,7 @@ public class Net{
             int p = object.getPriority();
 
             if(clientLoaded || p == Packet.priorityHigh){
+                ReplayController.onClientPacket(object);
                 if(clientListeners.get(object.getClass()) != null){
                     clientListeners.get(object.getClass()).get(object);
                 }else{
