From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Sat, 25 May 2024 20:34:18 +0800
Subject: [PATCH] FR(RenderExt) blockRenderLevel

---
 core/src/mindustry/core/Renderer.java              | 6 ++++--
 core/src/mindustry/entities/Effect.java            | 5 ++++-
 core/src/mindustry/entities/comp/BuildingComp.java | 3 +++
 core/src/mindustry/graphics/BlockRenderer.java     | 2 +-
 4 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/core/src/mindustry/core/Renderer.java b/core/src/mindustry/core/Renderer.java
index d4dddd92e7e5bb87c35120e9dedaebd0decdc4f5..b988dfe212a187b492194d010641611e6465e5b0 100644
--- a/core/src/mindustry/core/Renderer.java
+++ b/core/src/mindustry/core/Renderer.java
@@ -332,7 +332,8 @@ public class Renderer implements ApplicationListener{
 
         Draw.draw(Layer.background, this::drawBackground);
         Draw.draw(Layer.floor, blocks.floor::drawFloor);
-        Draw.draw(Layer.block - 1, blocks::drawShadows);
+        if(RenderExt.blockRenderLevel > 0)
+            Draw.draw(Layer.block - 1, blocks::drawShadows);
         Draw.draw(Layer.block - 0.09f, () -> {
             blocks.floor.beginDraw();
             blocks.floor.drawLayer(CacheLayer.walls);
@@ -417,7 +418,8 @@ public class Renderer implements ApplicationListener{
         }
 
         Events.fire(Trigger.drawOver);
-        blocks.drawBlocks();
+        if(RenderExt.blockRenderLevel > 0)
+            blocks.drawBlocks();
 
         Groups.draw.draw(RenderExt::onGroupDraw);
 
diff --git a/core/src/mindustry/entities/Effect.java b/core/src/mindustry/entities/Effect.java
index 3d948c538ea91437be30224408350cf6a29aedbd..341ca42edb3cdadba7cfe6fbb8a9b5e83a2f39c4 100644
--- a/core/src/mindustry/entities/Effect.java
+++ b/core/src/mindustry/entities/Effect.java
@@ -14,6 +14,7 @@ import mindustry.entities.effect.*;
 import mindustry.gen.*;
 import mindustry.graphics.*;
 import mindustry.world.*;
+import mindustryX.features.*;
 
 import static mindustry.Vars.*;
 
@@ -139,7 +140,9 @@ public class Effect{
     }
 
     public boolean shouldCreate(){
-        return !headless && this != Fx.none && Vars.renderer.enableEffects;
+        return !headless && this != Fx.none && Vars.renderer.enableEffects
+        //MDTX: hidden effects in buildings with low render level
+        && (RenderExt.blockRenderLevel > 1 || LogicExt.currentBuilding == null);
     }
 
     public void create(float x, float y, float rotation, Color color, Object data){
diff --git a/core/src/mindustry/entities/comp/BuildingComp.java b/core/src/mindustry/entities/comp/BuildingComp.java
index 617a74fc96070bfa9574e5326151cdf4ce60c726..ef6a02468d54efb19847f5794f3f2618e8fbf9ee 100644
--- a/core/src/mindustry/entities/comp/BuildingComp.java
+++ b/core/src/mindustry/entities/comp/BuildingComp.java
@@ -2228,7 +2228,10 @@ abstract class BuildingComp implements Posc, Teamc, Healthc, Buildingc, Timerc,
         updateConsumption();
 
         if(enabled || !block.noUpdateDisabled){
+            //MDTX: trace current Building. May use in debugging crash or in some special logic.
+            LogicExt.currentBuilding = self();
             updateTile();
+            LogicExt.currentBuilding = null;
         }
     }
 
diff --git a/core/src/mindustry/graphics/BlockRenderer.java b/core/src/mindustry/graphics/BlockRenderer.java
index e8aa2b654249f2f0d0c78c8400afa62c83a9109d..a22b49796d989df325e7d1920cafcf6dd408a27f 100644
--- a/core/src/mindustry/graphics/BlockRenderer.java
+++ b/core/src/mindustry/graphics/BlockRenderer.java
@@ -401,7 +401,7 @@ public class BlockRenderer{
         }
 
 
-        if(avgx == lastCamX && avgy == lastCamY && lastRangeX == rangex && lastRangeY == rangey){
+        if(RenderExt.blockRenderLevel <= 0 || avgx == lastCamX && avgy == lastCamY && lastRangeX == rangex && lastRangeY == rangey){
             return;
         }
 
