From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Sun, 14 Dec 2025 22:27:50 +0800
Subject: [PATCH] OC: optimize fonts update (picked from foo)

---
 .../src/arc/freetype/FreeTypeFontGenerator.java    | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/extensions/freetype/src/arc/freetype/FreeTypeFontGenerator.java b/extensions/freetype/src/arc/freetype/FreeTypeFontGenerator.java
index 992c82a8efbf0c1daf6e2bcf2d78b2b689b3b0a4..e23bc52fea6561d5a33b919940d89d222961831a 100755
--- a/extensions/freetype/src/arc/freetype/FreeTypeFontGenerator.java
+++ b/extensions/freetype/src/arc/freetype/FreeTypeFontGenerator.java
@@ -723,16 +723,18 @@ public class FreeTypeFontGenerator implements Disposable{
             return glyph;
         }
 
+        //MDTX: Don't update fonts more than once per frame (from https://github.com/mindustry-antigrief/Arc/commit/fed63f365839b5d0d3e8b6fe02307c373360e36e)
+        private boolean queued;
+
         public void getGlyphs(GlyphRun run, CharSequence str, int start, int end, Glyph lastGlyph){
             if(packer != null) packer.setPackToTexture(true); // All glyphs added after this are packed directly to the texture.
             super.getGlyphs(run, str, start, end, lastGlyph);
-            if(dirty && !ignoreDirty){
-                //queuing font updates fixes a crash on iOS.
+
+            if(dirty && !queued){
+                queued = true;
                 Core.app.post(() -> {
-                    if(dirty){
-                        dirty = false;
-                        packer.updateTextureRegions(regions, parameter.minFilter, parameter.magFilter, parameter.genMipMaps);
-                    }
+                    dirty = queued = false;
+                    packer.updateTextureRegions(regions, parameter.minFilter, parameter.magFilter, parameter.genMipMaps);
                 });
             }
         }
