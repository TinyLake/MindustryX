From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Sun, 14 Dec 2025 23:19:27 +0800
Subject: [PATCH] HC: Support reuse SDL-window for LoaderMod

---
 .../src/arc/backend/sdl/SdlApplication.java        | 14 ++++++++++++++
 .../src/arc/backend/sdl/SdlGraphics.java           |  3 ++-
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/backends/backend-sdl/src/arc/backend/sdl/SdlApplication.java b/backends/backend-sdl/src/arc/backend/sdl/SdlApplication.java
index cad8f97ed6dc623d7e1ccb88c0c31ec9d57761bd..0921a196f0bf76b8b33a3c311824e2d008c5e1db 100644
--- a/backends/backend-sdl/src/arc/backend/sdl/SdlApplication.java
+++ b/backends/backend-sdl/src/arc/backend/sdl/SdlApplication.java
@@ -134,6 +134,20 @@ public class SdlApplication implements Application{
 
         check(SDLInit.SDL_Init(SDLInit.SDL_INIT_VIDEO | SDLInit.SDL_INIT_EVENTS));
 
+        //MDTX: Special handle for Loader
+        if(System.getProperty("MDTX-SDL-window") != null){
+            Log.info("[Core] Initialize reusing window and context.");
+            window = Long.parseLong(System.getProperty("MDTX-SDL-window"));
+            context = Long.parseLong(System.getProperty("MDTX-SDL-context"));
+
+            config.width = Integer.parseInt(System.getProperty("MDTX-SDL-width"));
+            config.height = Integer.parseInt(System.getProperty("MDTX-SDL-height"));
+
+            String ver = SDLVersion.SDL_GetRevision();
+            Log.info("[Core] Initialized @ (@)", ver, SDLVideo.SDL_GetCurrentVideoDriver());
+            return;
+        }
+
         //show native IME candidate UI
         SDLHints.SDL_SetHint("SDL_IME_SHOW_UI","1");
         SDLHints.SDL_SetHint("SDL_WINDOWS_DPI_SCALING", "1");
diff --git a/backends/backend-sdl/src/arc/backend/sdl/SdlGraphics.java b/backends/backend-sdl/src/arc/backend/sdl/SdlGraphics.java
index d620ccf09e7f6da096a243312e4cdc316b176cb2..aed803baa8dbd66c09dd3b40b3e5c95ff8997ac3 100644
--- a/backends/backend-sdl/src/arc/backend/sdl/SdlGraphics.java
+++ b/backends/backend-sdl/src/arc/backend/sdl/SdlGraphics.java
@@ -38,7 +38,8 @@ public class SdlGraphics extends Graphics{
         this.app = app;
 
         Configuration.OPENGL_EXPLICIT_INIT.set(true);
-        GL.create(SDLVideo::SDL_GL_GetProcAddress);
+        //MDTX: skip if already initialized (for Loader)
+        if(GL.getFunctionProvider() == null) GL.create(SDLVideo::SDL_GL_GetProcAddress);
         GLCapabilities caps = GL.createCapabilities();
 
         Core.gl = Core.gl20 = gl20 = new SdlGL20();
