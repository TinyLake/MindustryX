From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Sun, 14 Dec 2025 23:19:27 +0800
Subject: [PATCH] HC: Support reuse SDL-window for LoaderMod

---
 .../src/arc/backend/sdl/SdlApplication.java       | 15 +++++++++++++++
 .../src/arc/backend/sdl/SdlApplication.java       | 14 ++++++++++++++
 .../src/arc/backend/sdl/SdlGraphics.java          |  3 ++-
 3 files changed, 31 insertions(+), 1 deletion(-)

diff --git a/backends/backend-sdl/src/arc/backend/sdl/SdlApplication.java b/backends/backend-sdl/src/arc/backend/sdl/SdlApplication.java
index f356fe21605f785cc84845c75a2c26568a9b5782..8248211d452110c3e158fe6cd3b1f995c775b38e 100644
--- a/backends/backend-sdl/src/arc/backend/sdl/SdlApplication.java
+++ b/backends/backend-sdl/src/arc/backend/sdl/SdlApplication.java
@@ -112,6 +112,21 @@ public class SdlApplication implements Application{
 
         if(OS.isMac) restartMac();
 
+        //MDTX: Special handle for Loader
+        if(System.getProperty("MDTX-SDL-window") != null){
+            Log.info("[Core] Initialize reusing window and context.");
+            window = Long.parseLong(System.getProperty("MDTX-SDL-window"));
+            context = Long.parseLong(System.getProperty("MDTX-SDL-context"));
+
+            config.width = Integer.parseInt(System.getProperty("MDTX-SDL-width"));
+            config.height = Integer.parseInt(System.getProperty("MDTX-SDL-height"));
+
+            int[] ver = new int[3];
+            SDL_GetVersion(ver);
+            Log.info("[Core] Initialized SDL v@.@.@", ver[0], ver[1], ver[2]);
+            return;
+        }
+
         check(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_EVENTS));
 
         //show native IME candidate UI
diff --git a/backends/backend-sdl3/src/arc/backend/sdl/SdlApplication.java b/backends/backend-sdl3/src/arc/backend/sdl/SdlApplication.java
index 35526aab2ddf686dd47e34410e85af140bd4e343..abbc29a7863e64cf511a21375bb123583a4fc8fd 100644
--- a/backends/backend-sdl3/src/arc/backend/sdl/SdlApplication.java
+++ b/backends/backend-sdl3/src/arc/backend/sdl/SdlApplication.java
@@ -124,6 +124,20 @@ public class SdlApplication implements Application{
 
         if(OS.isMac) restartMac();
 
+        //MDTX: Special handle for Loader
+        if(System.getProperty("MDTX-SDL-window") != null){
+            Log.info("[Core] Initialize reusing window and context.");
+            window = Long.parseLong(System.getProperty("MDTX-SDL-window"));
+            context = Long.parseLong(System.getProperty("MDTX-SDL-context"));
+
+            config.width = Integer.parseInt(System.getProperty("MDTX-SDL-width"));
+            config.height = Integer.parseInt(System.getProperty("MDTX-SDL-height"));
+
+            String ver = SDLVersion.SDL_GetRevision();
+            Log.info("[Core] Initialized @", ver);
+            return;
+        }
+
         if(OS.isLinux && !OS.hasEnvFlag("MINDUSTRY_FORCE_WAYLAND")){
             //Prefer x11, as Wayland seems to be broken: https://github.com/Anuken/Mindustry/issues/11657
             if("wayland".equalsIgnoreCase(System.getenv("XDG_SESSION_TYPE"))){
diff --git a/backends/backend-sdl3/src/arc/backend/sdl/SdlGraphics.java b/backends/backend-sdl3/src/arc/backend/sdl/SdlGraphics.java
index 20afcfb03738e2cb3bca006b4cb7835f0794ff80..b40488280136183c2208b111c8fd99d2f00e6ae5 100644
--- a/backends/backend-sdl3/src/arc/backend/sdl/SdlGraphics.java
+++ b/backends/backend-sdl3/src/arc/backend/sdl/SdlGraphics.java
@@ -38,7 +38,8 @@ public class SdlGraphics extends Graphics{
         this.app = app;
 
         Configuration.OPENGL_EXPLICIT_INIT.set(true);
-        GL.create(SDLVideo::SDL_GL_GetProcAddress);
+        //MDTX: skip if already initialized (for Loader)
+        if(GL.getFunctionProvider() == null) GL.create(SDLVideo::SDL_GL_GetProcAddress);
         GLCapabilities caps = GL.createCapabilities();
 
         Core.gl = Core.gl20 = gl20 = new SdlGL20();
